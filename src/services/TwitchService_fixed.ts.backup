import axios, { AxiosInstance } from 'axios';
import { TwitchStream, TwitchUser, TwitchApiResponse } from '../types';
import { logger } from '../utils/logger';
import { config } from '../utils/config';

export class TwitchService {
  private apiClient: AxiosInstance;
  private twitchConfig = config.getTwitchConfig();
  
  constructor() {
    this.apiClient = axios.create({
      baseURL: 'https://api.twitch.tv/helix',
      headers: {
        'Client-ID': this.twitchConfig.clientId,
        'Authorization': `Bearer ${this.twitchConfig.accessToken}`,
        'Content-Type': 'application/json',
      },
      timeout: 10000,
    });

    // ãƒªã‚¯ã‚¨ã‚¹ãƒˆ/ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®ã‚¤ãƒ³ã‚¿ãƒ¼ã‚»ãƒ—ã‚¿ãƒ¼
    this.setupInterceptors();
  }

  private setupInterceptors(): void {
    // ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚¤ãƒ³ã‚¿ãƒ¼ã‚»ãƒ—ã‚¿ãƒ¼
    this.apiClient.interceptors.request.use(
      (config) => {
        logger.debug(`Twitch APIãƒªã‚¯ã‚¨ã‚¹ãƒˆ: ${config.method?.toUpperCase()} ${config.url}`, 'ğŸ“¤');
        return config;
      },
      (error) => {
        logger.error('Twitch APIãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼', error, 'ğŸ“¤âŒ');
        return Promise.reject(error);
      }
    );

    // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¤ãƒ³ã‚¿ãƒ¼ã‚»ãƒ—ã‚¿ãƒ¼
    this.apiClient.interceptors.response.use(
      (response) => {
        logger.debug(`Twitch APIãƒ¬ã‚¹ãƒãƒ³ã‚¹: ${response.status} ${response.config.url}`, 'ğŸ“¥');
        return response;
      },
      async (error) => {
        if (error.response?.status === 401) {
          logger.warn('Twitch ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ãŒç„¡åŠ¹ã§ã™ã€‚æ›´æ–°ãŒå¿…è¦ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“', 'ğŸ”‘');
          // ã“ã“ã§ãƒˆãƒ¼ã‚¯ãƒ³ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Ÿè£…å¯èƒ½
        }
        logger.error(`Twitch APIã‚¨ãƒ©ãƒ¼: ${error.response?.status || 'Network Error'}`, error, 'ğŸ“¥âŒ');
        return Promise.reject(error);
      }
    );
  }

  /**
   * æŒ‡å®šã—ãŸãƒãƒ£ãƒ³ãƒãƒ«ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
   */
  public async getUserByLogin(login: string): Promise<TwitchUser | null> {
    try {
      logger.twitch(`ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—ä¸­: ${login}`);
      
      const response = await this.apiClient.get<TwitchApiResponse<TwitchUser>>('/users', {
        params: { login }
      });

      if (response.data.data.length === 0) {
        logger.warn(`ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${login}`, 'ğŸ‘¤âŒ');
        return null;
      }

      const user = response.data.data[0];
      logger.twitch(`ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—ã—ã¾ã—ãŸ: ${user.display_name} (ID: ${user.id})`);
      return user;
    } catch (error) {
      logger.error(`ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®å–å¾—ã«å¤±æ•—: ${login}`, error as Error);
      return null;
    }
  }

  /**
   * æŒ‡å®šã—ãŸãƒãƒ£ãƒ³ãƒãƒ«ã®é…ä¿¡çŠ¶æ³ã‚’ãƒã‚§ãƒƒã‚¯
   */
  public async getStreamStatus(channelName: string): Promise<TwitchStream | null> {
    try {
      logger.twitch(`é…ä¿¡çŠ¶æ³ã‚’ãƒã‚§ãƒƒã‚¯ä¸­: ${channelName}`);

      const response = await this.apiClient.get<TwitchApiResponse<TwitchStream>>('/streams', {
        params: { user_login: channelName }
      });

      if (response.data.data.length === 0) {
        logger.debug(`${channelName} ã¯ç¾åœ¨ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã§ã™`, 'ğŸ“´');
        return null;
      }

      const stream = response.data.data[0];
      logger.streaming(`ğŸ”´ ${channelName} ãŒé…ä¿¡ä¸­ï¼ - ${stream.title}`);
      logger.stats({
        'ã‚¿ã‚¤ãƒˆãƒ«': stream.title,
        'ã‚²ãƒ¼ãƒ ': stream.game_name,
        'è¦–è´è€…æ•°': stream.viewer_count,
        'é–‹å§‹æ™‚åˆ»': new Date(stream.started_at).toLocaleString('ja-JP'),
        'è¨€èª': stream.language,
      });

      return stream;
    } catch (error) {
      logger.error(`é…ä¿¡çŠ¶æ³ã®å–å¾—ã«å¤±æ•—: ${channelName}`, error as Error);
      return null;
    }
  }

  /**
   * é…ä¿¡ã®ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆURLï¼ˆM3U8ï¼‰ã‚’å–å¾—ã™ã‚‹
   * æ³¨æ„: ã“ã‚Œã¯éå…¬å¼ãªAPIã‚’ä½¿ç”¨ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™
   */
  public async getStreamPlaylistUrl(channelName: string): Promise<string | null> {
    try {
      logger.twitch(`ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆURLã‚’å–å¾—ä¸­: ${channelName}`);

      // Twitch ã®éå…¬å¼ API ã‚’ä½¿ç”¨ã—ã¦ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã‚’å–å¾—
      console.log('ğŸ› [DEBUG] GraphQL APIã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡ä¸­...');
      
      const accessTokenResponse = await axios.post('https://gql.twitch.tv/gql', [{
        operationName: 'PlaybackAccessToken_Template',
        query: 'query PlaybackAccessToken_Template($login: String!, $isLive: Boolean!, $vodID: ID!, $isVod: Boolean!, $playerType: String!) {  streamPlaybackAccessToken(channelName: $login, params: {platform: "web", playerBackend: "mediaplayer", playerType: $playerType}) @include(if: $isLive) {    value    signature   }  videoPlaybackAccessToken(id: $vodID, params: {platform: "web", playerBackend: "mediaplayer", playerType: $playerType}) @include(if: $isVod) {    value    signature  }}',
        variables: {
          login: channelName,
          isLive: true,
          vodID: '',
          isVod: false,
          playerType: 'site'
        }
      }], {
        headers: {
          'Client-ID': 'kimne78kx3ncx6brgo4mv6wki5h1ko',
          'Content-Type': 'application/json',
        }
      });

      console.log('ğŸ› [DEBUG] GraphQLãƒ¬ã‚¹ãƒãƒ³ã‚¹:', JSON.stringify(accessTokenResponse.data, null, 2));

      if (!accessTokenResponse.data[0]?.data?.streamPlaybackAccessToken) {
        console.log('ğŸ› [DEBUG] streamPlaybackAccessTokenãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ');
        logger.warn(`ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã®å–å¾—ã«å¤±æ•—: ${channelName}`, 'ğŸ”‘âŒ');
        return null;
      }

      const { value, signature } = accessTokenResponse.data[0].data.streamPlaybackAccessToken;
      console.log('ğŸ› [DEBUG] ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—æˆåŠŸ');
      
      // ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆURLã‚’æ§‹ç¯‰
      const playlistUrl = `https://usher.ttvnw.net/api/channel/hls/${channelName}.m3u8?client_id=kimne78kx3ncx6brgo4mv6wki5h1ko&token=${encodeURIComponent(value)}&sig=${signature}&allow_source=true&allow_audio_only=true&allow_spectre=true&p=${Math.floor(Math.random() * 1000000)}`;

      logger.success(`ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆURLã‚’å–å¾—ã—ã¾ã—ãŸ: ${channelName}`);
      logger.debug(`URL: ${playlistUrl.substring(0, 100)}...`);

      return playlistUrl;
    } catch (error) {
      console.log('ğŸ› [DEBUG] getStreamPlaylistUrlã§ã‚¨ãƒ©ãƒ¼:', error);
      logger.error(`ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆURLã®å–å¾—ã«å¤±æ•—: ${channelName}`, error as Error);
      return null;
    }
  }

  /**
   * é…ä¿¡ã®å“è³ªã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’å–å¾—
   */
  public async getStreamQualities(playlistUrl: string): Promise<string[]> {
    try {
      logger.debug('é…ä¿¡å“è³ªã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’å–å¾—ä¸­...', 'ğŸ“Š');

      const response = await axios.get(playlistUrl);
      const playlist = response.data;

      // M3U8ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã‹ã‚‰å“è³ªã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è§£æ
      const qualities: string[] = [];
      const lines = playlist.split('\n');

      for (let i = 0; i < lines.length; i++) {
        if (lines[i].startsWith('#EXT-X-STREAM-INF')) {
          const qualityLine = lines[i];
          const nextLine = lines[i + 1];
          
          if (nextLine && nextLine.startsWith('http')) {
            const resolution = qualityLine.match(/RESOLUTION=(\d+x\d+)/)?.[1];
            const bandwidth = qualityLine.match(/BANDWIDTH=(\d+)/)?.[1];
            
            qualities.push(nextLine);
            logger.debug(`å“è³ªã‚ªãƒ—ã‚·ãƒ§ãƒ³: ${resolution || 'unknown'} (${bandwidth ? Math.round(parseInt(bandwidth) / 1000) + 'kbps' : 'unknown bitrate'})`);
          }
        }
      }

      logger.info(`${qualities.length}å€‹ã®å“è³ªã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ç™ºè¦‹ã—ã¾ã—ãŸ`, 'ğŸ“Š');
      return qualities;
    } catch (error) {
      logger.error('é…ä¿¡å“è³ªã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®å–å¾—ã«å¤±æ•—', error as Error);
      return [];
    }
  }

  /**
   * ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã®æœ‰åŠ¹æ€§ã‚’ãƒã‚§ãƒƒã‚¯
   */
  public async validateToken(): Promise<boolean> {
    try {
      logger.debug('Twitchãƒˆãƒ¼ã‚¯ãƒ³ã®æœ‰åŠ¹æ€§ã‚’ãƒã‚§ãƒƒã‚¯ä¸­...', 'ğŸ”‘');
      
      const response = await this.apiClient.get('/users');
      
      if (response.status === 200) {
        logger.success('Twitchãƒˆãƒ¼ã‚¯ãƒ³ã¯æœ‰åŠ¹ã§ã™');
        return true;
      }
      
      return false;
    } catch (error) {
      logger.error('Twitchãƒˆãƒ¼ã‚¯ãƒ³ãŒç„¡åŠ¹ã§ã™', error as Error, 'ğŸ”‘âŒ');
      return false;
    }
  }

  /**
   * ãƒ¬ãƒ¼ãƒˆåˆ¶é™æƒ…å ±ã‚’å–å¾—
   */
  public getLastRateLimitInfo(): { remaining: number; reset: number } | null {
    // æœ€å¾Œã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ˜ãƒƒãƒ€ãƒ¼ã‹ã‚‰ãƒ¬ãƒ¼ãƒˆåˆ¶é™æƒ…å ±ã‚’å–å¾—
    // å®Ÿè£…ã¯çœç•¥ï¼ˆå¿…è¦ã«å¿œã˜ã¦å®Ÿè£…ï¼‰
    return null;
  }
}
